@using Inventory.LunarMed.Web.Models;
@model ListProductsViewModel
@{
    ViewBag.Title = "Products";
}


<div class="span9">
    <div class="content">
        @Html.Partial("_ViewMessageList", Model.Messages)
        <div class="module">
            <div class="module-head overflow-hidden">
                <h3 class="pull-left">
                    Products
                </h3>
                <div class="pull-right">
                    <a class="btn btn-small btn-info" id="addNewProduct">Add New</a>
                </div>
            </div>
            <div class="module-body table">
                <table cellpadding="0" cellspacing="0" border="0" class="datatable-1 table table-bordered table-striped	display">
                    <thead>
                        <tr>
                            <th>
                                Product ID
                            </th>
                            <th>
                                Name
                            </th>
                            <th>
                                Batch Number
                            </th>
                            <th>
                                Selling Price
                            </th>
                            <th>
                                Quantity
                            </th>
                            <th>
                                Expiration Date
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Products)
                        {
                        <tr class="@((item.ProductId % 2) == 1 ? "odd" : "even")">
                            <td>@Html.DisplayFor(modelItem => item.ProductId)</td>
                            <td>@Html.DisplayFor(modelItem => item.Name)</td>
                            <td>@Html.DisplayFor(modelItem => item.BatchNumber)</td>
                            <td>@Html.DisplayFor(modelItem => item.SellingPrice)</td>
                            <td>@Html.DisplayFor(modelItem => item.StockQuantity)</td>
                            <td>@Html.DisplayFor(modelItem => item.ExpirationDate)</td>
                            <td><a href="#" class="dt-link edit-product" style="text-decoration: none;"><i class="icon-edit dt-icon"></i> Edit</a> | <a href="#" class="dt-link delete-product-conf" style="text-decoration: none;"><i class="icon-remove dt-icon"></i> Delete</a></td>
                        </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>
                                Product ID
                            </th>
                            <th>
                                Name
                            </th>
                            <th>
                                Batch Number
                            </th>
                            <th>
                                Selling Price
                            </th>
                            <th>
                                Quantity
                            </th>
                            <th>
                                Expiration Date
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <!--/.module-->
    </div>
    <!--/.content-->
</div>
<!--/.span9-->

<div id="modalContainer" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <div class="control-group">
                    <div class="controls">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
<script type="text/javascript">

    initDataTable();

    // Add new Product click event
    $('body').on('click', 'a#addNewProduct', function (e) {

        var url = "Product/Create"; // Full URL

        /* Cleanup */
        cleanModal();

        $('.modal-dialog').css('height', '580px');
        $('.modal-body').css('height', '470px');

        /* Close popups on click elsewhere */
        /* Source: http://stackoverflow.com/a/14857326/364 */
        $('body').on('click', function (e) {
            var popovers = [$('#btn-modal-share')];
            $.each(popovers, function () {
                //the 'is' for buttons that trigger popups
                //the 'has' for icons within a button that triggers a popup
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                    $(this).popover('hide');
                }
            });
        });

        $.ajax({
            url: url,
            type: "GET",
            success: function (result) {
                result = '<div>' + result + '</div>';
                $('.modal-title').html($(result).find('h2').html());
                $('.modal-body').html(result);
                $('.modal-body').find('h2').remove();

                $('#modalContainer').modal();

                $("#expirateDate").datepicker();
                $("#purchaseDate").datepicker();
            }
        });

    });

    // Edit Product Link Click Event
    $('.module-body').on('click', '.edit-product', function (e) {
        var id = $(this).parent().parent().children('td:first').text();

        var url = "Product/Edit/" + id; // Full URL

        /* Cleanup */
        cleanModal();

        /* Close popups on click elsewhere */
        /* Source: http://stackoverflow.com/a/14857326/364 */
        $('body').on('click', function (e) {
            var popovers = [$('#btn-modal-share')];
            $.each(popovers, function () {
                //the 'is' for buttons that trigger popups
                //the 'has' for icons within a button that triggers a popup
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                    $(this).popover('hide');
                }
            });
        });

        $.ajax({
            url: url,
            type: "GET",
            success: function (result) {
                result = '<div>' + result + '</div>';
                $('.modal-title').html($(result).find('h2').html());
                $('.modal-body').html(result);
                $('.modal-body').find('h2').remove();
                $('#modalContainer').modal();
            }
        });

        e.preventDefault();
    });

    // This event acts like the Confirmation message for the Delete Operation
    $('body').on('click', '.delete-product-conf', function (e) {
        // Cleanup
        cleanModal();

        // Display the Confirmation Message with its contents
        $('.modal-title').html('<h4>Delete Product Confirmation</h4>');

        var id = $(this).parent().parent().children('td:first').text();
        var name = $(this).parent().parent().children('td:nth-child(2)').text();
        $('.modal-body').append('<h5>Are you sure you want to delete this product?</h5><br /><b>Name</b>: ' + name);
        $('.modal-body').append('<input type="hidden" id="hfProductId" value="' + id + '" />');
        $('.modal-footer').append('<button type="button" class="btn btn-info delete-product">Delete</button>');
        $('#modalContainer').modal();
    });

    // This is the delete client click event and calls the ajax service to delete the product
    $('body').on('click', '.delete-product', function (e) {
        var url = "Product/Delete"; // Full URL
        var data = JSON.stringify({ id: $('#hfProductId').val() });

        $.ajax({
            url: url,
            data: data,
            contentType: "application/json;charset=utf-8",
            type: "POST",
            success: function (result) {
                $('#divMessages').html(result);
                loadData();
                $('#modalContainer').modal('hide');
            }
        });
    });

    function loadData() {
        $.ajax({
            url: "/Product/List",
            type: "GET",
            success: function (result) {
                $('.module-body').html('').html(result);
                initDataTable();
            }
        });
    }

</script>
}
